<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Experience</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script>
      let videoEl, audioEl, quizAudioEl;

      AFRAME.registerComponent('scene-manager', {
        init: function () {
          this.loadScene1();
        },
        loadScene1: function () {
          this.el.sceneEl.querySelector('#sky').setAttribute('src', 'assets/scene1.jpg');
          audioEl = new Audio('assets/audio_intro.mp3');
          audioEl.play();
          this.showButton('Enter', () => this.loadScene2());
        },
        loadScene2: function () {
          this.clearUI();
          this.el.sceneEl.querySelector('#sky').setAttribute('src', 'assets/scene2.jpg');
          audioEl = new Audio('assets/audio_scene2.mp3');
          audioEl.play();
          this.showImageButton('assets/video_thumbnail.jpg', () => this.playVideo());
        },
        playVideo: function () {
          this.clearUI();
          if (audioEl) audioEl.pause();
          videoEl = document.querySelector('#video1');
          videoEl.play();
          videoEl.onended = () => this.showQuiz();
          this.showVideoControls();
        },
        showQuiz: function () {
          this.clearUI();
          quizAudioEl = new Audio('assets/audio_quiz.mp3');
          quizAudioEl.play();
          this.showButton('Yes', () => this.loadScene3('A'));
          this.showButton('No', () => this.loadScene3('B'));
        },
        loadScene3: function (type) {
          this.clearUI();
          let sceneImg = `assets/scene3${type}.jpg`;
          let sceneAudio = new Audio(`assets/audio_scene3${type}.mp3`);
          this.el.sceneEl.querySelector('#sky').setAttribute('src', sceneImg);
          sceneAudio.play();
          this.showButton('Restart', () => this.loadScene1());
        },
        showButton: function (text, onClick) {
          let btn = document.createElement('a-entity');
          btn.setAttribute('geometry', 'primitive: circle; radius: 0.2');
          btn.setAttribute('material', 'color: blue');
          btn.setAttribute('text', `value: ${text}; align: center; color: white; width: 2`);
          btn.setAttribute('position', `${Math.random()-0.5} 1.5 -2`);
          btn.setAttribute('class', 'clickable');
          btn.addEventListener('click', onClick);
          btn.setAttribute('cursor-listener', '');
          this.el.appendChild(btn);
        },
        showImageButton: function (src, onClick) {
          let imgBtn = document.createElement('a-image');
          imgBtn.setAttribute('src', src);
          imgBtn.setAttribute('width', '1');
          imgBtn.setAttribute('height', '0.6');
          imgBtn.setAttribute('position', '0 1.5 -2');
          imgBtn.setAttribute('class', 'clickable');
          imgBtn.addEventListener('click', onClick);
          imgBtn.setAttribute('cursor-listener', '');
          this.el.appendChild(imgBtn);
        },
        showVideoControls: function () {
          const positions = [
            { text: 'Start', action: () => videoEl.currentTime = 0, pos: '-0.8 0.5 -2' },
            { text: 'End', action: () => videoEl.currentTime = videoEl.duration, pos: '0.8 0.5 -2' },
            { text: '-10s', action: () => videoEl.currentTime = Math.max(0, videoEl.currentTime - 10), pos: '-0.8 -0.2 -2' },
            { text: '+10s', action: () => videoEl.currentTime = Math.min(videoEl.duration, videoEl.currentTime + 10), pos: '0.8 -0.2 -2' }
          ];
          positions.forEach(p => {
            let btn = document.createElement('a-entity');
            btn.setAttribute('geometry', 'primitive: circle; radius: 0.15');
            btn.setAttribute('material', 'color: red');
            btn.setAttribute('text', `value: ${p.text}; align: center; color: white; width: 1.5`);
            btn.setAttribute('position', p.pos);
            btn.setAttribute('class', 'clickable');
            btn.addEventListener('click', p.action);
            btn.setAttribute('cursor-listener', '');
            this.el.appendChild(btn);
          });
        },
        clearUI: function () {
          this.el.querySelectorAll('.clickable').forEach(el => el.remove());
        }
      });

      AFRAME.registerComponent('cursor-listener', {
        init: function () {
          this.el.addEventListener('mouseenter', () => {
            this.el.setAttribute('scale', '1.2 1.2 1');
          });
          this.el.addEventListener('mouseleave', () => {
            this.el.setAttribute('scale', '1 1 1');
          });
        }
      });
    </script>
  </head>
  <body>
    <a-scene scene-manager>
      <a-assets>
        <video id="video1" src="assets/video.mp4" crossorigin="anonymous"></video>
      </a-assets>
      <a-sky id="sky" color="#000"></a-sky>
      <a-camera position="0 1.6 0">
        <a-cursor fuse="true" fuse-timeout="1500"></a-cursor>
      </a-camera>
    </a-scene>
  </body>
</html>
